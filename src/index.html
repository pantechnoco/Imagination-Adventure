<html>
    <head>
        <title>Imagine Adventure</title>
        <style>
            #canvas {
                width: 512px;
                height: 512px;
            }
        </style>
    </head>
    <body onload="init()">
        <canvas id="canvas" width="128" height="128" />
        <script type="text/javascript">
        var canvas
        ,   engine
        ,   ctx
        ,   layers
        ,   sprites
        ,   tileset
        
        ,   TILEWIDTH

        ,   K_LEFT = 37
        ,   K_UP = 38
        ,   K_RIGHT = 39
        ,   K_DOWN = 40

        ,   T_TRANSPARENT = 0
        ,   T_WHITE = 63
        ,   T_BLACK = 7
        ,   T_GRAY = 31
        ,   T_GRAY = 31
        ,   T_LTBLUE = 12
        ;

        function Layer(h, w) {
            this.offx = 0;
            this.offy = 0;
            this.height = h;
            this.width = w;
            for (var h_i=0; h_i<h; h_i++) {
                for (var w_i=0; w_i<h; w_i++) {
                    this.push(T_TRANSPARENT);
                }
            }
        };
        Layer.prototype = (new Array());
        Layer.prototype.draw = function() {
            var x, y, i, l = this.width * this.height;
            for (i=0; i<l; i++) {
                x = (i % this.width) * 8 + this.offx;
                y = parseInt(i / TILEWIDTH) * 8 + this.offy;
                engine.blit(this[i], x, y);
            }
        };
        Layer.prototype.setAll = function(t) {
            var x, y, i, l = this.width * this.height;
            for (i=0; i<l; i++) {
                this[i] = t;
            }
        };
        Layer.prototype.get = function(x, y) {
            var i = (y * this.width) + x
            ,   t = this[i]
            ;
            return t;
        };
        Layer.prototype.set = function(x, y, t) {
            var i = (y * this.width) + x
            ;
            this[i] = t;
        };

        function Sprite(x, y, t) {
            this.x = x;
            this.y = y;
            this.t = t;
        }
        Sprite.prototype.draw = function() {
            engine.blit(this.t, this.x, this.y);
        };
        Sprite.prototype.tick = function() {

        };

        function SpriteGroup(x, y, sprites) {
            this.x = x;
            this.y = y;
            this.sprites = sprites;
        }
        SpriteGroup.prototype.draw = function() {
            var sl = this.sprites.length
            ,   i
            ,   s
            ,   x = this.x
            ,   y = this.y
            ;
            layers[0].draw();
            layers[1].draw();
            for (i=0; i<sl; i++) {
                s = this.sprites[i];
                engine.blit(s.t, x+s.x, y+s.y);
            }
            layers[2].draw();
            layers[3].draw();
        };
        SpriteGroup.prototype.tick = function() {
            var ty = parseInt((this.y + 8) / 8);
            var tx = parseInt((this.x - layers[2].offx) / 8);
            var under = layers[2].get(tx, ty);
            console.debug(tx, ty, under);
            if (under == 0) {
                this.move(0, 1);
            }
        };
        SpriteGroup.prototype.move = function(x, y) {
            this.x += x;
            this.y += y;
            if (x != 0 || y != 0) {
                this.draw();
            }
        }

        function init() {
            engine = new Engine();
        }

        function Engine() {
            this.keystate = keystate = [];
            window.onkeydown = function(e) {
                keystate[e.keyCode] = true;
                return false;
            }
            window.onkeyup = function(e) {
                keystate[e.keyCode] = false;
                return false;
            }

            this.last_frame;
            this.canvas = document.getElementById('canvas');
            this.ctx = this.canvas.getContext('2d');
            this.tilesets = [];

            TILEWIDTH = this.canvas.getAttribute('width') / 8;

            layers = [];
            layers.push(new Layer(TILEWIDTH, TILEWIDTH));
            layers.push(new Layer(TILEWIDTH, TILEWIDTH));
            layers.push(new Layer(TILEWIDTH, TILEWIDTH));
            layers.push(new Layer(TILEWIDTH, TILEWIDTH));

            sprites = [];
            sprites.push(new SpriteGroup(50, 50, [
                new Sprite(0,  0, 3)
            ,   new Sprite(0, -8, 3+8)
            ]));

            layers[3][0] = 65;
            layers[3][1] = 64;
            layers[3][2] = 64;

            layers[3][13] = 64 + 56;
            layers[3][14] = 64 + 56;
            layers[3][15] = 64 + 58;

            for (var i=0; i<16; i++) {
                layers[2].set(i, 12, 28);
                layers[2].set(i, 13, 27);
                layers[2].set(i, 14, 27);
                layers[2].set(i, 15, 27);
            }

            layers[0].setAll(T_LTBLUE);

            this.loadTilesets("tileset.png", "alphanum.png");
        }
        Engine.prototype.loadTilesets = function() {
            var tileset
            ,   to_load = arguments.length
            ,   engine = this
            ;

            for (var i=0; i<arguments.length; i++) {
                tileset = new Image();
                this.tilesets.push(tileset)
                tileset.onload = function() {
                    to_load -= 1; 
                    if (to_load === 0) {
                        engine.start()
                    }
                };
                tileset.src = arguments[i] + "?ts=" + (new Date().toISOString());
            }

        }
        Engine.prototype.blit = function blit(i, x, y) {
            var sx = (i % 64) % 8
            ,   sy = parseInt((i % 64) / 8)
            ,   tileset = this.tilesets[parseInt(i / 64)]
            ;
            if (x >= 0 && x < 128 && y >= 0 && y < 128) {
                this.ctx.drawImage(tileset, sx*8, sy*8, 8, 8, x, y, 8, 8);
            }
        }
        Engine.prototype.start = function start() {
            layers[0].draw();
            layers[1].draw();

            var sl = sprites.length, si;
            for (si=0; si<sl; si++) {
                sprites[si].draw();
                sprites[si].tick();
            }

            layers[2].draw();
            layers[3].draw();

            requestAnimFrame(function(){
                engine.tick()
            });
        }
        Engine.prototype.tick = function() {
            var t = new Date();
            if (typeof this.last_frame != "undefined") {
                // console.debug(parseInt(1000 / (t.getTime() - this.last_frame.getTime())) + " fps");
            }
            this.last_frame = t;

            var sl = sprites.length, si;
            for (si=0; si<sl; si++) {
                sprites[si].tick();
            }

            if (this.keystate[K_RIGHT]) {
                //sprites[0].move(1, 0);
                layers[2].offx -= 1;
                layers[2].draw();
            } else if (this.keystate[K_LEFT]) {
                //sprites[0].move(-1, 0);
                layers[2].offx += 1;
                layers[2].draw();
            }

            requestAnimFrame(function() {
                engine.tick();
            });
        }

        /**
         * Provides requestAnimationFrame in a cross browser way.
         */
        window.requestAnimFrame = (function() {
          return window.requestAnimationFrame ||
                 window.webkitRequestAnimationFrame ||
                 window.mozRequestAnimationFrame ||
                 window.oRequestAnimationFrame ||
                 window.msRequestAnimationFrame ||
                 function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
                   window.setTimeout(callback, 1000/60);
                 };
        })();
        </script>
    </body>
</html>
